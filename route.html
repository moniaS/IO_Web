<!DOCTYPE html>
<html>

<head>
    <!--Import Google Icon Font-->
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css" media="screen,projection" />
    <!--Import main.css-->
    <link type="text/css" rel="stylesheet" href="css/main.css" media="screen,projection" />
    <link type="text/css" rel="stylesheet" href="css/style.css" media="screen,projection" />
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.1/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.1/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.1/firebase-storage.js"></script>
    <script type="text/javascript" src="js/materialize.min.js"></script>

    <script src="js/custom.js"></script>
</head>

<body>
    <ul id="userDropdown" class="dropdown-content">
        <li><a href="profile.html">My Profile</a></li>
        <li><a href="#!">Settings</a></li>
        <li class="divider"></li>
        <li class="logout-btn"><a>Logout</a></li>
    </ul>
    <!--nav Bar-->
    <nav>
        <div class="nav-wrapper cyan darken-1">
            <ul id="nav-mobile" class="right hide-on-med-and-down">
                <li><a href=""><i class="material-icons">search</i></a></li>
                <li><a href=""><i class="material-icons">view_module</i></a></li>
                <li><a href=""><i class="material-icons">refresh</i></a></li>
                <li><a class="dropdown-button" data-activates="userDropdown"><span class="username"></span><i class="material-icons right">person</i></a></li>
            </ul>

        </div>
    </nav>
    <!--main content-->
    <div class="container">
        <div class="row">
            <div class="post">
                <div class="col s8">
                    <div id="map"></div>
                    <div id="naviButton"><i class="small material-icons" data-position="bottom" data-delay="50" data-tooltip="Let me ride this!">navigation</i></div>
                </div>
                <div class="col s4">
                    <div data-position="right" data-delay="50">
                        <div class="closestWaypoints scroll">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--footer-->
    <footer class="page-footer cyan darken-1">
        <div class="container">
            <div class="row">
                <div class="col l6 s12">
                    <h5 class="white-text">Footer Content</h5>
                    <p class="grey-text text-lighten-4">You can use rows and columns here to organize your footer content.</p>
                </div>
                <div class="col l4 offset-l2 s12">
                    <h5 class="white-text">Links</h5>
                    <ul class="footerLinks">
                        <li><a class="grey-text text-lighten-3" href="#!">Link 1</a></li>
                        <li><a class="grey-text text-lighten-3" href="#!">Link 2</a></li>
                        <li><a class="grey-text text-lighten-3" href="#!">Link 3</a></li>
                        <li><a class="grey-text text-lighten-3" href="#!">Link 4</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="footer-copyright">
            <div class="container">
                Â© 2014 Copyright Text
                <a class="grey-text text-lighten-4 right" href="#!">More Links</a>
            </div>
        </div>
    </footer>
    <div id="waypointInfoModal" class="modal">
        <div class="modal-content">
            <a class="boxclose modal-close">&#10006;</a>
            <div class="slider">
                <ul class="slides"></ul>
                <input type="file" id="uploadFileInput" multiple style="display: none">
                <a id="uploadFileBtn" class="waves-effect waves-light btn" style="float: left;">add photo</a>
            </div>
            <div class="waypointContainer">
            <div class="waypointInfo">
                <div class="card-panel grey lighten-5 z-depth-1">
                    <div class="title">
                        <i class="small material-icons" data-position="bottom" data-delay="50" style="color: #00acc1!important;">location_on</i>
                        <span class="value" />
                    </div>
                    <hr class="line">
                    <div class="description">
                        <span class="value" />
                    </div>
                    <!--<div class="address">-->
                        <!--<i class="small material-icons tooltipped" data-position="bottom" data-delay="50">location_on</i>-->
                        <!--<span>Address: </span><span class="value" />-->
                    <!--</div>-->
                </div>
            </div>
            <div class="commentSection card-panel grey lighten-5 z-depth-1">
                <div class="newComment">
                    <textarea rows="4" cols="50" placeholder="your comment"></textarea>
                    <a class="waves-effect waves-light btn addCommentBtn">add</a>
                </div>
                <div class="comments">
                </div>
            </div>
        </div>

        </div>
        <div class="modal-footer">
        </div>
    </div>
    <script>
        var database = firebase.database();
        var routeRef = database.ref('Cities/Lodz/Routes/' + localStorage.getItem("routeId"));

        <!--Initializes map-->
        function initMap() {
            routeRef.on('value', function(snapshot) {
                var trackpoints = [];
                snapshot.child("trackPoints").forEach(function(childSnapshot) {
                        var trackPoint = {};
                        trackPoint.lat = childSnapshot.child("coordinate/latitude").val();
                        trackPoint.lng = childSnapshot.child("coordinate/longitude").val();
                        trackpoints.push(trackPoint);
                })
                var middleTrackpoint = parseInt(trackpoints.length/2);
                var map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 16,
                    center: new google.maps.LatLng(trackpoints[middleTrackpoint].lat, trackpoints[middleTrackpoint].lng)
                });
                initRoute(trackpoints, map);
            });
        }

        <!--Initializes route on map by trackpoints-->
        function initRoute(trackpoints, map) {
            var route = new google.maps.Polyline({
                path: trackpoints,
                geodesic: true,
                strokeColor: '#0000FF',
                strokeOpacity: 1.0,
                strokeWeight: 2,
                clickable: true,
            });
            route.setMap(map);
            initClosestWaypoints(trackpoints, map, 1);
        }

        <!--Initializes the closest waypoints to route-->
        function initClosestWaypoints(trackpoints, map, maxDistance) {
            var wayPointsRef = database.ref('Cities/Lodz/WayPoints');
            var addedWaypoints = [];
            for (var i = 0; i < trackpoints.length; i++) {
                var trackPoint = new google.maps.LatLng(trackpoints[i].lat, trackpoints[i].lng);

                wayPointsRef.on('value', function (snapshot) {
                    snapshot.forEach(function (childSnapshot) {
                        var childData = childSnapshot.val();
                        var wayPoint = new google.maps.LatLng(childData.coordinate.latitude, childData.coordinate.longitude);
                        var distance = (google.maps.geometry.spherical.computeDistanceBetween(trackPoint, wayPoint) / 1000).toFixed(2);
                        if (distance < maxDistance && $.inArray(childData.id, addedWaypoints) === -1) {
                            addedWaypoints.push(childData.id);
                            var marker = new google.maps.Marker({
                                position: wayPoint,
                                map: map
                            });

                            findUsernameById(childData.authorId, function (username) {
                                if(username != undefined) {
                                    $(".closestWaypoints").append("<div class='waypointDetails' data-id=" + childData.id + "><div class='waypointName'>" + childData.address + "</div><div class='waypointDesc'><div class='waypointDesc'>Author: " + username + "</div>Description: " + childData.description + "</div></div>");
                                }
                            });

                            google.maps.event.addListener(marker, 'click', (function (marker, i) {
                                return function () {
                                    waypointClickHandler(childData.id);
                                }
                            })(marker, i));

                        }
                    })
                })
            }
        }
//
//        FireBaseRef.once('value', function(snapshot) {
//            var prev_name= snapshot.val(); // Sonta
//            FireBaseRef.set({
//                "value": new_name,
//                "prev_value": prev_name
//            })
//        });

        function findUser(callback) {
            var usersRef = firebase.database().ref("Users");
            var username;
            usersRef.orderByChild('email').equalTo($(".username").html()).once("value", function (snapshot) {
                var data = snapshot.val();
                if(data != null) {
                    user = data[Object.keys(data)[0]];
                    callback(user)
                }
            })
        }



        <!--Is invoked when user clicks on waypoint(on map or in closest waypoints section) and is used to show all waypoints-->
        function waypointClickHandler(waypointId) {
            findUser(function (user) {
                var counter = user.waypointsCounter;
                if(user.role == "nonSubscriber" && counter > 0) {
                    var databaseRef = database.ref('Users').child(user.key);

                    databaseRef.once('value', function(snapshot) {
                        if( snapshot.val() != null ) {
                            var oldCounter = Number(snapshot.val().waypointsCounter);
                            $(".waypointDetails").remove();
                            snapshot.ref.update({"waypointsCounter": oldCounter - 1});
                            showWaypointInfoModal(waypointId);
                        }
                    });
                } else if(user.role == "nonSubscriber") {
                    alert("You have no left waypoints to see. Subscription needed!");
                }
            });
        }

        function showWaypointInfoModal(waypointId) {
            $(".slides").find("li").remove();
            $(".indicators").remove();
            $(".slider").slider();
            $(".slider").slider('pause');
            var chosenWaypoint = database.ref('Cities/Lodz/WayPoints/' + waypointId);
            chosenWaypoint.on('value', function(snapshot) {
                $(".comment").remove();
                var snapshotData = snapshot.val();
                snapshot.child("comments").forEach(function(childSnapshot) {
                    var childSnapshotData = childSnapshot.val();
                    findUsernameById(childSnapshotData.authorId, function (username) {
                        appendComment(username,
                            (new Date(childSnapshotData.timestamp)).toLocaleString(),childSnapshotData.message);
                    })

                })
                $("#waypointInfoModal").modal({
                        ready: function (modal, trigger) {
                            modal.data("id", snapshotData.id);
                            $($(".waypointsDetails").remove());

                        },
                        dismissible: false
                    }
                );
                $("#waypointInfoModal").modal('open');
                $(".waypointInfo .title .value").html(snapshotData.address);
                $(".waypointInfo .description .value").html(snapshotData.description);
                getImagesFromStorage(snapshotData.id);
                if($(".slides").find("li").length == 0) {
                    $(".slider").hide();
                } else {
                    $(".slider").show();
                }
            })
        }




        <!--Adds new comment to waypoint-->
        function addComment(authorId, message) {
            var seconds = + new Date();
            $(".comment").remove();
            var rootRef = firebase.database().ref();
            var waypointId = $("#waypointInfoModal").data("id");
            var commentsRef = rootRef.child('Cities/Lodz/WayPoints/' + waypointId + '/comments/');
            var newComment = commentsRef.push();
            newComment.set({
                authorId: authorId,
                message: message,
                timestamp: seconds
            });
            $(".slides").find("li").remove();
            $(".indicators").remove();
            getImagesFromStorage(waypointId);
        }

        <!--Append comment in comments section-->
        function appendComment(authorId, date, message) {
            $(".comments").prepend("<div class='comment'><span class='commentAuthorId'>" + authorId + "</span><span class='commentDate'>" + date + "</span><span class='commentMessage'>" + message + "</span></div>")
        }

        <!--Closes waypoint info modal-->
        function closeWaypointInfoModal() {
            $("#waypointInfoModal").modal('close');
            $(document).off("keyup");
            return false;
        }

        <!--Shows all waypoints from the closest waypoints section-->
        function showAllWaypoints() {
            var elements = $(".closestWaypoints").find('.waypointDetails');
            var index = 0;
            waypointClickHandler(elements.eq(index).data("id"));
            var interval = setInterval(function () {
                index++;
                waypointClickHandler(elements.eq(index).data("id"));
                if(index == elements.length - 1) {
                    $("#waypointInfoModal").modal('close');
                    clearInterval(interval);
                }
            }, 20000);

            $(document).on("keyup", function (event) {
                if (event.keyCode == 39) {
                    clearInterval(interval);
                    index++;
                    if(index == elements.length) {
                        return closeWaypointInfoModal();
                    }
                    waypointClickHandler(elements.eq(index).data("id"));

                } else if(event.keyCode == 37) {
                    clearInterval(index);
                    index--;
                    if(index == -1) {
                        return closeWaypointInfoModal();
                    }
                    waypointClickHandler(elements.eq(index).data("id"));
                }
            })

        }

        <!--CLICK EVENTS-->
        $(".logout-btn").on("click", function() {
            firebase.auth().signOut().then(function() {
                window.location = "login.html"
            }, function(error) {});
        });

        $(".addCommentBtn").off().on("click", function() {
            $(".comment").remove();
            addComment(firebase.auth().currentUser.uid, $(".newComment textarea").val());
            $(".newComment textarea").val("");
        });

        $(".closestWaypoints").delegate(".waypointDetails", "click", function(event) {
            waypointClickHandler($(event.target).closest('.waypointDetails').data("id"));
        });

        $("#uploadFileBtn").on("click", function () {
            $("#uploadFileInput").click();
        });

        $("#uploadFileInput").on("change input", function () {
            addImages($("#waypointInfoModal").data("id"),$("#uploadFileInput")[0].files);
        });

        $("#naviButton").on("click", function () {
            showAllWaypoints()
        });
    </script>
    <!--Import jQuery before materialize.js-->

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCyaOvUpwamVCDPcXn2eLH_JTi8bVrQ9Is&callback=initMap"></script>
</body>
</html>
