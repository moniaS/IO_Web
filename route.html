<!DOCTYPE html>
<html>

<head>
    <!--Import Google Icon Font-->
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css" media="screen,projection" />
    <!--Import main.css-->
    <link type="text/css" rel="stylesheet" href="css/main.css" media="screen,projection" />
    <link type="text/css" rel="stylesheet" href="css/style.css" media="screen,projection" />
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.1/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.1/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.1/firebase-storage.js"></script>

    <script src="js/custom.js"></script>
</head>

<body>
    <ul id="userDropdown" class="dropdown-content">
        <li><a href="#!">My Profile</a></li>
        <li><a href="#!">Settings</a></li>
        <li class="divider"></li>
        <li class="logout-btn"><a>Logout</a></li>
    </ul>
    <!--nav Bar-->
    <nav>
        <div class="nav-wrapper cyan darken-1">
            <img class="logoImg" src="images/logo.png">
            <ul id="nav-mobile" class="right hide-on-med-and-down">
                <li><a href=""><i class="material-icons">search</i></a></li>
                <li><a href=""><i class="material-icons">view_module</i></a></li>
                <li><a href=""><i class="material-icons">refresh</i></a></li>
                <li><a class="dropdown-button" data-activates="userDropdown"><span class="username"></span><i class="material-icons right">person</i></a></li>
            </ul>

        </div>
    </nav>
    <!--main content-->
    <div class="container">
        <div class="row">
            <div class="col s12">
                <div class="row">
                    <div class="col s7">
                        <div id="actionBar">
                            <div class="col s3">
                                <div id="naviButton"><i class="medium material-icons tooltipped" data-position="bottom" data-delay="50" data-tooltip="Let me ride this!">navigation</i></div>
                            </div>
                            <div class="col s3">
                                <div id="favorite"><i class="medium material-icons tooltipped" data-position="bottom" data-delay="50" data-tooltip="Add to: favorite">stars</i></div>
                            </div>
                            <div class="col s3">
                                <div id="gotoLocation"><i class="medium material-icons tooltipped" data-position="bottom" data-delay="50" data-tooltip="Take me to starting point">location_on</i> </div>
                            </div>
                            <div class="col s3">
                                <div id="rideLater"><i class="medium material-icons tooltipped" data-position="bottom" data-delay="50" data-tooltip="Add to: Ride later">done</i> </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="post">
                <div class="col s8">
                        <div id="map"></div>
                </div>
                <div class="col s4">
                    <div class="scroll">
                        <div data-position="right" data-delay="50">
                            <div class="closestWaypoints">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
             <div class="col s7">
                <div class="waypointInfo">
                    <div class="card-panel grey lighten-5 z-depth-1">
                        <div class="title">
                            <span class="value" />
                        </div>
                        <hr class="line">
                        <div class="description">
                            <i class="small material-icons tooltipped" data-position="bottom" data-delay="50">description</i>
                            <span>Description: </span><span class="value" />
                        </div>
                        <div class="coordinates">
                            <i class="small material-icons tooltipped" data-position="bottom" data-delay="50">location_on</i>
                            <span>Coordinate: </span><span class="value" />
                        </div>
                        <div class="images">
                            <i class="small material-icons tooltipped" data-position="bottom" data-delay="50">image</i>
                            <span>Images: </span><span class="value" />
                            <img id="mainImage" height="400" width="400"/>
                        </div>
                    </div>
                </div>
            </div>
          <div class="col s5">
            <div class="commentSection card-panel grey lighten-5 z-depth-1">
              <div class="newComment">
                <textarea rows="4" cols="50" placeholder="your comment"></textarea>
                <button class="addCommentBtn">ADD</button>
              </div>
              <div class="comments">
              </div>
            </div>
          </div>
        </div>
    </div>
    <!--footer-->
    <footer class="page-footer cyan darken-1">
        <div class="container">
            <div class="row">
                <div class="col l6 s12">
                    <h5 class="white-text">Footer Content</h5>
                    <p class="grey-text text-lighten-4">You can use rows and columns here to organize your footer content.</p>
                </div>
                <div class="col l4 offset-l2 s12">
                    <h5 class="white-text">Links</h5>
                    <ul>
                        <li><a class="grey-text text-lighten-3" href="#!">Link 1</a></li>
                        <li><a class="grey-text text-lighten-3" href="#!">Link 2</a></li>
                        <li><a class="grey-text text-lighten-3" href="#!">Link 3</a></li>
                        <li><a class="grey-text text-lighten-3" href="#!">Link 4</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="footer-copyright">
            <div class="container">
                Â© 2014 Copyright Text
                <a class="grey-text text-lighten-4 right" href="#!">More Links</a>
            </div>
        </div>
    </footer>
    <div id="newWaypointModal" class="modal">
        <div class="modal-content">
            <h4><i class="small material-icons tooltipped" data-position="bottom" data-delay="50">location_on</i>Waypoint</h4>
            <div class="coordinateOnModal">
                <span>Latitude: </span>
                <span class="waypointLatitude"></span><br>
                <span>Longitude: </span>
                <span class="waypointLongitude"></span>
                <input placeholder="Name" class="waypointName" />
                <input class="waypointDesc" placeholder="Description"/>
                <form action="#">
                    <div class="file-field input-field">
                        <div class="btn">
                            <span>File</span>
                            <input id="imagesInput" type="file" multiple>
                        </div>
                        <div class="file-path-wrapper">
                            <input class="file-path validate" type="text" placeholder="Upload one or more files">
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#" class=" modal-action modal-close waves-effect waves-green btn-flat">Cancel</a>
            <a href="#" class=" modal-action modal-close waves-effect waves-green btn-flat save-btn">Save</a>
        </div>
    </div>
    <script>
        var database = firebase.database();
        var routeRef = database.ref('Schemat/Content/Cities/Lodz/Routes/' + localStorage.getItem("routeId"));
        function initMap() {
            routeRef.on('value', function(snapshot) {
                var trackpoints = [];
                snapshot.child("trackPoints").forEach(function(childSnapshot) {
                        var trackPoint = {};
                        trackPoint.lat = childSnapshot.child("coordinate/latitude").val();
                        trackPoint.lng = childSnapshot.child("coordinate/longitude").val();
                        trackpoints.push(trackPoint);
                })
                var map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 8,
                    center: new google.maps.LatLng(trackpoints[0].lat, trackpoints[0].lng)
                });
                initRoute(trackpoints, map);
            });
        }

        function initRoute(trackpoints, map) {
            var route = new google.maps.Polyline({
                path: trackpoints,
                geodesic: true,
                strokeColor: '#0000FF',
                strokeOpacity: 1.0,
                strokeWeight: 2,
                clickable: true,
            });
            route.setMap(map);
            initClosestWaypoints(trackpoints, map, 10);
        }

        function initClosestWaypoints(trackpoints, map, maxDistance) {
            var wayPointsRef = database.ref('Schemat/Content/Cities/Lodz/WayPoints');
            var addedWaypoints = new Array();
            for (var i = 0; i < trackpoints.length; i++) {
                 var trackPoint = new google.maps.LatLng(trackpoints[i].lat, trackpoints[i].lng);

                 wayPointsRef.on('value',function(snapshot) {
                    snapshot.forEach(function(childSnapshot) {
                        var childData = childSnapshot.val();
                        var wayPoint = new google.maps.LatLng(childData.coordinate.latitude, childData.coordinate.longitude);
                        var distance = (google.maps.geometry.spherical.computeDistanceBetween(trackPoint, wayPoint)/1000).toFixed(2);
                        if(distance < maxDistance && $.inArray(childData.id, addedWaypoints) === -1) {
                            addedWaypoints.push(childData.id);
                            var marker = new google.maps.Marker({
                                position: wayPoint,
                                map: map
                            });

                            google.maps.event.addListener(marker, 'click', (function(marker, i) {
                                 return function() {
                                    $(".waypointInfo").slideDown();
                                    scrollToWaypointInfo();
                                    $(".waypointInfo .title .value").html(childData.id);
                                    $(".waypointInfo .description .value").html(childData.description);
                                    $(".waypointInfo .coordinates .value").html(childData.coordinate.latitude + ", " + childData.coordinate.longitude);
                                     getImagesFromStorage(childData.id);
                                 }
                            })(marker, i));
                            $(".closestWaypoints").append("<div class='waypointDetails'><div class='waypointName'>" + childData.id + "</div><div class='waypointDesc'>Description: " + childData.description + "</div></div>");
                        }
                    })
                })
            }
        }

        $(".logout-btn").on("click", function() {
            firebase.auth().signOut().then(function() {
                window.location = "login.html"
            }, function(error) {});
        });

        $(".addCommentBtn").on("click", function() {
            $(".comment").remove();
            addComment(firebase.auth().currentUser.uid, $(".newComment textarea").val());
            $(".newComment textarea").val("");
        })

        $(".closestWaypoints").delegate(".waypointDetails", "click", function(event) {
            $(".waypointInfo").slideDown();
            $(".commentSection").slideDown();
            $(".comment").remove();
            setTimeout(scrollToWaypointInfo(), 300);
            var chosenWaypoint = database.ref('Schemat/Content/Cities/Lodz/WayPoints/' + $(this).find('.waypointName').html());
                chosenWaypoint.on('value', function(snapshot) {
                 snapshot.child("comments").forEach(function(childSnapshot) {
                     var childSnapshotData = childSnapshot.val();
                     appendComment(childSnapshotData.authorId,
                              (new Date(childSnapshotData.timestamp)).toLocaleString(),childSnapshotData.message);
                })
                var snapshotData = snapshot.val();
                 getImagesFromStorage(snapshotData.id);
                $(".waypointInfo .title .value").html(snapshotData.id);
                $(".waypointInfo .description .value").html(snapshotData.description);
                $(".waypointInfo .coordinates .value").html(snapshotData.coordinate.latitude + ", " + snapshotData.coordinate.longitude);
            })
         });
        function addComment(authorId, message) {
            var seconds = + new Date();
            $(".comment").remove();
            var rootRef = firebase.database().ref();
            var waypointId = $(".waypointInfo").find(".title .value").html();
            var commentsRef = rootRef.child('Schemat/Content/Cities/Lodz/WayPoints/' + waypointId + '/comments/');
            var newComment = commentsRef.push();
            newComment.set({
                authorId: authorId,
                message: message,
                timestamp: seconds
            });
        }
        function appendComment(authorId, date, message) {
            $(".comments").prepend("<div class='comment'><span class='commentAuthorId'>" + authorId + "</span><span class='commentDate'>" + date + "</span><span class='commentMessage'>" + message + "</span></div>")
        }

        function scrollToWaypointInfo() {
            $('html,body').animate({
                scrollTop: $(".waypointInfo").offset().top},
                'slow');
        }

        function getImagesFromStorage(waypointId) {
            var chosenWaypoint = database.ref('Schemat/Content/Cities/Lodz/WayPoints/' + waypointId);
            chosenWaypoint.on('value', function(snapshot) {
                snapshot.child("photos").forEach(function(childSnapshot) {
                    var childData = childSnapshot.val();
                    $("#mainImage").attr('src', childData.downloadUrl);
                })
            })
        }
    </script>
    <!--Import jQuery before materialize.js-->

    <script type="text/javascript" src="js/materialize.min.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCyaOvUpwamVCDPcXn2eLH_JTi8bVrQ9Is&callback=initMap"></script>
</body>
</html>
